<!doctype html>
<html>
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Admin Dashboard</title><link rel="stylesheet" href="theme.css"></head>
<body>
<div style="padding:18px">
  <header style="display:flex;align-items:center;gap:12px;">
    <h1>Admin Dashboard</h1>
    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <input id="adminOverrideToken" class="small-input" placeholder="Override Bot Token">
      <input id="adminOverrideChat" class="small-input" placeholder="Override Chat ID">
      <button id="saveOverride" class="btn">Set Override</button>
      <input id="adminSecretIn" class="small-input" placeholder="Admin secret (required)">
    </div>
  </header>

  <main style="display:grid;grid-template-columns:360px 1fr;gap:12px;margin-top:18px">
    <aside>
      <div class="card">
        <h3>Quick Stats</h3>
        <div id="statLeads">Leads (30d): 0</div>
        <div id="statContractors">Contractors: 0</div>
        <div id="statReviews">Reviews: 0</div>
      </div>

      <div class="card">
        <h3>Theme Editor (multicolor)</h3>
        <label>Accent color <input type="color" id="accentColor" value="#7b61ff"></label><br>
        <label>Accent to <input type="color" id="accentTo" value="#42b3ff"></label><br>
        <label>Gradient hue <input id="gradientHue" type="range" min="0" max="360" value="250"></label><br>
        <button id="applyTheme" class="btn">Apply Theme</button>
      </div>

      <div class="card">
        <h3>Subscription Plans</h3>
        <div>
          <h4>Standard</h4>
          <div>1 month: R350</div>
          <div>6 months: R1999</div>
          <div>1 year: R3599 (discounted)</div>
        </div>
        <hr>
        <div>
          <h4>Premium</h4>
          <div>1 month: R500</div>
          <div>6 months: R2599</div>
          <div>1 year: R4999 (discounted)</div>
        </div>
      </div>
    </aside>

    <section>
      <div class="card">
        <h3>Contractors</h3>
        <div id="contractorsList"></div>
      </div>

      <div class="card">
        <h3>Leads (recent)</h3>
        <div id="leadsList"></div>
      </div>

      <div class="card">
        <h3>Actions</h3>
        <div>
          <label>Assign badge <select id="badgeSelect"><option value="bronze">Bronze</option><option value="silver">Silver</option><option value="gold">Gold</option><option value="platinum">Platinum</option><option value="premium">Premium+</option></select></label>
          <input id="badgeForId" class="small-input" placeholder="Contractor ID">
          <button id="applyBadge" class="btn">Apply Badge</button>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
async function loadData() {
  const leads = await fetch('/api/logs/leads').then(r=>r.json()).catch(()=>[]);
  const contractors = await fetch('/api/logs/contractors').then(r=>r.json()).catch(()=>[]);
  document.getElementById('leadsList').innerHTML = leads.slice(0,40).map(l=>`<div class="mini">${l.ts} — ${l.name||'-'} — ${l.phone||'-'} — ${l.service||'-'}</div>`).join('');
  document.getElementById('contractorsList').innerHTML = contractors.slice(0,100).map(c=>`<div class="mini">${c.ts} — ${c.company||c.name||'-'} — ${c.phone||'-'} — ${c.service||'-'} <button class="btn" onclick="deactivate('${c.id||c.phone||c.ts}')">Deactivate</button> <button class="btn" onclick="extendSub('${c.id||c.phone||c.ts}')">Extend Sub</button></div>`).join('');
  document.getElementById('statLeads').textContent = `Leads (30d): ${leads.length}`;
  document.getElementById('statContractors').textContent = `Contractors: ${contractors.length}`;
  document.getElementById('statReviews').textContent = `Reviews: ${ (await fetch('/api/logs/reviews').then(r=>r.json()).catch(()=>[])).length }`;
}
function deactivate(id) { if(confirm('Deactivate contractor?')) alert('Deactivated (demo)'); }
function extendSub(id) { const months = prompt('Extend by how many months?'); if (months) alert('Extended (demo)'); }

document.getElementById('applyTheme').addEventListener('click', ()=>{
  const from = document.getElementById('accentColor').value;
  const to = document.getElementById('accentTo').value;
  document.documentElement.style.setProperty('--accent-from', from);
  document.documentElement.style.setProperty('--accent-to', to);
  alert('Theme applied locally. To persist across users store setting server-side.');
});

document.getElementById('applyBadge').addEventListener('click', async ()=>{
  const badge = document.getElementById('badgeSelect').value;
  const id = document.getElementById('badgeForId').value;
  const secret = document.getElementById('adminSecretIn').value;
  if (!secret) return alert('Admin secret required');
  const res = await fetch('/api/set-override', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ adminSecret: secret, overrideToken: '', overrideChatId: '' })});
  alert('Badge applied (demo). For full persistence use proper DB updates.');
});

window.addEventListener('load', loadData);
</script>
</body>
</html>
