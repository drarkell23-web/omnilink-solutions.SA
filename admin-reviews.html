<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OmniSolutions — Admin Panel</title>
<link rel="stylesheet" href="theme.css">
<script type="module" src="Firebase-bridge.js" defer></script>
<style>
.container{max-width:1200px;margin:18px auto;padding:12px}
.row{display:flex;gap:12px;align-items:flex-start}
.col{flex:1}
.card{background:var(--panel);border-radius:12px;padding:12px;border:1px solid #ffffff12}
.small-input{padding:8px;border-radius:8px;background:#080716;border:1px solid #ffffff12;color:var(--ink)}
.badge-icon{display:inline-flex;align-items:center;padding:6px 10px;border-radius:999px}
.badge-bronze{background:linear-gradient(90deg,#8c5a20,#6b4414);color:#fff}
.badge-silver{background:linear-gradient(90deg,#d1d5db,#9aa3ad);color:#081018}
.badge-gold{background:linear-gradient(90deg,#f6c84c,#f0b020);color:#081018}
.badge-platinum{background:linear-gradient(90deg,#bcdfff,#88e0f4);color:#081018}
.badge-premium{background:linear-gradient(90deg,#7be6c7,#4bd8c0);color:#081018}
</style>
</head>
<body>
<div class="container">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div style="font-weight:900">Omni Admin — Settings & Reviews</div>
    <div style="display:flex;gap:8px;align-items:center">
      <div class="small">Live Leads: <strong id="liveLeads">0</strong></div>
      <button onclick="location.href='index.html'" class="btn">View Site</button>
    </div>
  </div>

  <div style="margin-top:12px" class="row">
    <div class="col card">
      <h3 style="margin-top:0">Telegram Bot Integration (secure)</h3>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <label style="min-width:95px">Bot Token</label>
        <input id="tgToken" class="small-input" style="flex:1" placeholder="Paste bot token (admin only)">
      </div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap">
        <label style="min-width:95px">Admin Chat ID</label>
        <input id="tgChatId" class="small-input" style="width:220px" placeholder="Admin chat id">
        <button id="tgSave" class="btn">Save & Test</button>
      </div>
      <div style="margin-top:8px;color:var(--muted)">Settings saved securely to Firestore by admin-only callable function. To set admin rights see functions/README-deploy.txt.</div>
    </div>

    <div class="col card">
      <h3 style="margin-top:0">Themes (10)</h3>
      <div id="themesGrid" style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px"></div>
      <h3 style="margin-top:12px">Badge Mix (Preview)</h3>
      <canvas id="badgeChart" height="120"></canvas>
    </div>
  </div>

  <div style="margin-top:12px" class="card">
    <h3 style="margin-top:0">Recent Reviews & Moderation</h3>
    <div id="reviewsTable" style="margin-top:8px"></div>
  </div>
</div>

<script type="module">
import { onLeadsSnapshot, setTelegramSettingsAdmin } from './Firebase-bridge.js';
import { getAuth } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';
import Chart from 'https://cdn.jsdelivr.net/npm/chart.js';

const liveLeads = document.getElementById('liveLeads');
onLeadsSnapshot(({count})=> liveLeads.textContent = count);

/* Themes grid */
const themes = [
  {name:"Default", vars:{"--bg":"#0b0a18","--panel":"#141229","--brand1":"#8a5cff","--brand2":"#6a4cff","--ink":"#f6f7fb"}},
  {name:"Ocean", vars:{"--bg":"#071226","--panel":"#0b2233","--brand1":"#06b6d4","--brand2":"#3b82f6","--ink":"#e9f8ff"}},
  {name:"Sunrise", vars:{"--bg":"#1b0b0b","--panel":"#2b1111","--brand1":"#ff7a59","--brand2":"#ffd36b","--ink":"#fff8f2"}},
  {name:"Forest", vars:{"--bg":"#08120b","--panel":"#0f2616","--brand1":"#22c55e","--brand2":"#16a34a","--ink":"#eaffef"}},
  {name:"Lavender", vars:{"--bg":"#0c0716","--panel":"#191023","--brand1":"#b392ff","--brand2":"#8a5cff","--ink":"#f8f5ff"}},
  {name:"Neon", vars:{"--bg":"#030305","--panel":"#081018","--brand1":"#00ffcc","--brand2":"#00aaff","--ink":"#e6fff9"}},
  {name:"Warm", vars:{"--bg":"#160f07","--panel":"#24160d","--brand1":"#ff9f43","--brand2":"#ff6b6b","--ink":"#fff7ee"}},
  {name:"Slate", vars:{"--bg":"#081018","--panel":"#111827","--brand1":"#94a3b8","--brand2":"#64748b","--ink":"#f3f6fb"}},
  {name:"Candy", vars:{"--bg":"#0b0710","--panel":"#1a1630","--brand1":"#ff6ea1","--brand2":"#ffd6e0","--ink":"#fff3fb"}},
  {name:"Gold", vars:{"--bg":"#050302","--panel":"#221b12","--brand1":"#f6d365","--brand2":"#fda085","--ink":"#fffaf0"}}
];

const grid = document.getElementById('themesGrid');
themes.forEach(t=>{
  const b = document.createElement('button'); b.className='btn'; b.textContent=t.name;
  b.onclick = ()=>{ Object.keys(t.vars).forEach(k=>document.documentElement.style.setProperty(k, t.vars[k])); localStorage.setItem('omni_theme', JSON.stringify(t.vars)); window.dispatchEvent(new CustomEvent('omni_theme_changed',{detail:t.vars})); };
  grid.appendChild(b);
});

/* badge chart demo */
const ctx = document.getElementById('badgeChart').getContext('2d');
new Chart(ctx, {
  type:'doughnut',
  data:{ labels:['Bronze','Silver','Gold','Platinum','Premium'], datasets:[{data:[60,10,8,12,10], backgroundColor:['#6b4a15','#c7c7c7','#f6c84c','#bcdfff','#7be6c7']}]}
});

/* Telegram Save & Test (uses callable setTelegramSettingsAdmin) */
const tgTokenInput = document.getElementById('tgToken');
const tgChatIdInput = document.getElementById('tgChatId');
const tgSave = document.getElementById('tgSave');

tgSave.addEventListener('click', async ()=>{
  const bt = tgTokenInput.value.trim();
  const cid = tgChatIdInput.value.trim();
  if (!bt || !cid) return alert("Enter token & chat id.");
  const auth = getAuth();
  if (!auth.currentUser) return alert("Please sign in as admin first.");
  // call callable function via client helper
  const res = await setTelegramSettingsAdmin(bt, cid);
  if (res && res.ok) alert("Saved Telegram settings.");
  else alert("Failed: " + (res?.error || JSON.stringify(res)));
});

/* reviews moderation: live list */
import { collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
(async ()=>{
  const { db } = await import('./Firebase-bridge.js');
  const q = query(collection(db,"contractor_reviews"), orderBy("created","desc"));
  onSnapshot(q, snap=>{
    const t = document.getElementById('reviewsTable');
    t.innerHTML = '';
    snap.forEach(d=>{
      const r = d.data();
      const row = document.createElement('div');
      row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='8px 0';
      const left = document.createElement('div');
      left.innerHTML = `<div style="font-weight:800">${r.name||'-'} • ${r.stars||5}★</div><div class="small">${r.text||''}</div>`;
      const right = document.createElement('div');
      const images = (r.images||[]).map(u=>`<img src="${u}" style="width:60px;height:40px;object-fit:cover;border-radius:6px;margin-left:6px">`).join('');
      right.innerHTML = `<div>${images}</div><div style="margin-top:6px"><span class="badge-icon ${r.status==='approved'?'badge-premium':''}">${r.status||'pending'}</span></div>`;
      row.appendChild(left); row.appendChild(right);
      t.appendChild(row);
    });
  });
})();
</script>
</body>
</html>
