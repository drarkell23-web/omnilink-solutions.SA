<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>OmniSolutions â€” Admin Reviews Panel</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --bg:#0b0a18;--panel:#141229;--ink:#f6f7fb;--muted:#aeb2cf;
  --brand1:#8a5cff;--brand2:#6a4cff;--ring:#ffffff22;
}
body{margin:0;font-family:Poppins,system-ui;background:var(--bg);color:var(--ink)}
.btn{background:linear-gradient(135deg,var(--brand1),var(--brand2));border:none;border-radius:10px;color:#10092a;
  padding:8px 14px;font-weight:700;cursor:pointer;transition:.2s}
.btn:hover{opacity:.95;transform:translateY(-1px)}
.shell{display:grid;grid-template-columns:240px 1fr;min-height:100dvh}
aside{background:#100f26;border-right:1px solid #ffffff14;padding:14px;position:sticky;top:0;height:100dvh}
.logo{font-weight:900;background:linear-gradient(135deg,var(--brand1),var(--brand2));-webkit-background-clip:text;
  color:transparent;font-size:20px;margin-bottom:16px}
.nav a{display:block;color:#eaeaff;padding:10px;border-radius:10px;text-decoration:none}
.nav a:hover,.nav a.active{background:#16133a}
main{display:grid;grid-template-rows:auto 1fr}
.top{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#100f26;
border-bottom:1px solid #ffffff14}
.container{width:min(1200px,94vw);margin:16px auto;padding-bottom:40px}
.grid{display:grid;gap:12px}
.kpis{grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}
.card{background:var(--panel);border:1px solid #ffffff18;border-radius:14px;padding:14px;box-shadow:0 8px 22px #0007}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:10px;border-bottom:1px solid #ffffff14;text-align:left;vertical-align:top}
.badge{padding:3px 8px;border-radius:999px;font-size:12px}
.badge.on{background:#0f2a1c;color:#23d59f}
.badge.off{background:#3a1a22;color:#ffa3a3}
img.review-img{width:80px;height:80px;object-fit:cover;border-radius:8px;margin:3px}
.fadeUp{opacity:0;transform:translateY(12px);transition:.5s ease}
.fadeUp.show{opacity:1;transform:none}
</style>
</head>
<body>
<div class="shell">
  <aside>
    <div class="logo">Omni Admin</div>
    <nav class="nav">
      <a href="dashboard.html">ğŸ  Dashboard</a>
      <a href="admin-reviews.html" class="active">â­ Reviews</a>
    </nav>
    <div style="margin-top:16px;display:grid;gap:8px">
      <button id="refreshBtn" class="btn">ğŸ” Refresh</button>
      <button id="logoutBtn" class="btn">ğŸšª Logout</button>
      <button onclick="location.href='index.html'" class="btn">ğŸ  Home</button>
    </div>
  </aside>

  <main>
    <div class="top"><div style="font-weight:800">â­ Review Moderation Panel</div></div>
    <div class="container">

      <!-- KPIs -->
      <section class="grid kpis">
        <div class="card fadeUp"><div style="color:#cfd2ff">Total Reviews</div><div id="kpiTotal" style="font-size:26px;font-weight:900">â€”</div></div>
        <div class="card fadeUp"><div style="color:#cfd2ff">Approved</div><div id="kpiApproved" style="font-size:26px;font-weight:900">â€”</div></div>
        <div class="card fadeUp"><div style="color:#cfd2ff">Hidden</div><div id="kpiHidden" style="font-size:26px;font-weight:900">â€”</div></div>
        <div class="card fadeUp"><div style="color:#cfd2ff">Images</div><div id="kpiImages" style="font-size:26px;font-weight:900">â€”</div></div>
      </section>

      <!-- Charts -->
      <section class="grid" style="grid-template-columns:2fr 1fr;margin-top:12px">
        <div class="card fadeUp"><div style="font-weight:800;margin-bottom:6px">Reviews per Star Rating</div><canvas id="starChart" height="150"></canvas></div>
        <div class="card fadeUp"><div style="font-weight:800;margin-bottom:6px">Approval Status</div><canvas id="statusChart" height="150"></canvas></div>
      </section>

      <!-- Review Table -->
      <section class="card fadeUp" style="margin-top:12px">
        <div style="font-weight:800;margin-bottom:8px">Contractor Reviews</div>
        <table class="table" id="reviewsTable">
          <thead><tr><th>Contractor</th><th>Stars</th><th>Review</th><th>Images</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>

    </div>
  </main>
</div>

<script type="module">
import { db } from "./Firebase-bridge.js";
import { collection, getDocs, updateDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

/* Admin login */
if(!localStorage.getItem("adminLoggedIn")){
  const pwd=prompt("Enter admin password:");
  if(pwd==="admin123"){localStorage.setItem("adminLoggedIn","true");}
  else{alert("Access denied");location.href="index.html";}
}

/* Animations */
const io=new IntersectionObserver((entries)=>entries.forEach(e=>{if(e.isIntersecting)e.target.classList.add('show')}),{threshold:.1});
document.querySelectorAll('.fadeUp').forEach(el=>io.observe(el));

const tbody=document.querySelector("#reviewsTable tbody");
let starChart,statusChart;

document.getElementById("logoutBtn").onclick=()=>{localStorage.removeItem("adminLoggedIn");location.href="index.html";}
document.getElementById("refreshBtn").onclick=()=>loadAll();

async function loadAll(){
  tbody.innerHTML="";
  const snap=await getDocs(query(collection(db,"contractor_reviews"),orderBy("created","desc")));

  const stats={total:0,approved:0,hidden:0,images:0,stars:[0,0,0,0,0]};
  const reviews=[];

  snap.forEach(d=>{
    const r=d.data(); r.id=d.id; stats.total++;
    const state=r.status||"approved";
    if(state==="approved") stats.approved++; else stats.hidden++;
    if(r.images?.length) stats.images+=r.images.length;
    stats.stars[(r.stars||5)-1]++;

    reviews.push(r);
  });

  // KPIs
  kpiTotal.textContent=stats.total;
  kpiApproved.textContent=stats.approved;
  kpiHidden.textContent=stats.hidden;
  kpiImages.textContent=stats.images;

  // Table
  reviews.forEach(r=>{
    const imgs=(r.images||[]).map(u=>`<img src="${u}" class="review-img">`).join("");
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${r.contractorPhone||"-"}</td>
      <td>${"â˜…".repeat(r.stars||5)}${"â˜†".repeat(5-(r.stars||5))}</td>
      <td>${r.text||""}</td>
      <td>${imgs||"â€”"}</td>
      <td><span class="badge ${r.status!=="hidden"?"on":"off"}">${r.status!=="hidden"?"Approved":"Hidden"}</span></td>
      <td style="display:flex;gap:6px;flex-wrap:wrap">
        <button class="btn approve">âœ… Approve</button>
        <button class="btn hide">ğŸš« Hide</button>
        <button class="btn del" style="background:#ff3b3b;color:#fff">ğŸ—‘ Delete</button>
      </td>`;
    tbody.appendChild(tr);

    tr.querySelector(".approve").onclick=()=>updateState(r.id,"approved");
    tr.querySelector(".hide").onclick=()=>updateState(r.id,"hidden");
    tr.querySelector(".del").onclick=()=>updateState(r.id,"deleted");
  });

  renderCharts(stats);
}

async function updateState(id,state){
  if(state==="deleted"){
    if(!confirm("Delete this review permanently?")) return;
    await updateDoc(doc(db,"contractor_reviews",id),{status:"deleted"});
  } else {
    await updateDoc(doc(db,"contractor_reviews",id),{status:state});
  }
  loadAll();
}

/* Charts */
function renderCharts(s){
  if(starChart) starChart.destroy();
  if(statusChart) statusChart.destroy();
  const anim={animation:{duration:800,easing:'easeOutQuart'}};

  starChart=new Chart(document.getElementById("starChart"),{
    type:"bar",
    data:{labels:["1â˜…","2â˜…","3â˜…","4â˜…","5â˜…"],datasets:[{data:s.stars,backgroundColor:["#aa4444","#bb6644","#cc8844","#ddaa44","#eee444"]}]},
    options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}},...anim}
  });

  statusChart=new Chart(document.getElementById("statusChart"),{
    type:"doughnut",
    data:{labels:["Approved","Hidden"],datasets:[{data:[s.approved,s.hidden],backgroundColor:["#23d59f","#ff6677"]}]},
    options:{plugins:{legend:{labels:{color:"#eaeaff"}}},...anim}
  });
}

loadAll();
</script>
</body>
</html>
